---
 - hosts: zabbix
   vars: 
     DBHost: localhost
     DBName: zabbixdb
     DBUser: zabbix
     DBPassword: root

     zabbix_url: http://repo.zabbix.com/zabbix/3.4/rhel/7/x86_64/zabbix-release-3.4-2.el7.noarch.rpm
     Time_zone: Asia/Bangkok 

   tasks:
     - name: Install mariadb
       yum:
         name: mariadb-server
         state: latest
       notify: service mariadb
     
     - name: Dowsload Zabbix RPM
       shell: rpm -Uvh http://repo.zabbix.com/zabbix/3.4/rhel/7/x86_64/zabbix-release-3.4-2.el7.noarch.rpm

     - name: Install Zabbix-Server-mysql
       yum:
         name: zabbix-server-mysql 
         state: latest

     - name: Install Zabbix-web-mysql
       yum:
         name: zabbix-web-mysql
         state: latest

     - name: Install Zabbix-Proxy-mysql
       yum:
         name: zabbix-proxy-mysql
         state: latest
      
     - name: Set timezone
        shell: "sed -i 's/# php_value date.timezone Europe/Riga/php_value date.timezone Asia/Bangkok/g' /etc/httpd/conf.d/zabbix.conf"
        
     - name: restart httpd service        
        service:
          name: httpd
          state: restarted

     - name: set db env
        shell: mysql -u root -p <<EOF
CREATE DATABASE zabbixdb CHARACTER SET UTF8;
GRANT ALL PRIVILEGES on zabbixdb.* to zabbix@localhost IDENTIFIED BY '';
FLUSH PRIVILEGES;
quit
EOF
      

   handlers:
    - name: service mariadb
      service:
           name=mariadb
           state=started
           enabled=True
    - name: service zabbix
      service:
           name=zabbix
           state=started
           enabled=True
